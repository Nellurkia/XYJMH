<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>æœˆç»å‡ºè¡€é‡ä¼°ç®—å™¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 0; max-width: 100%; margin: 0; }
    
    /* é¡¶éƒ¨å¯¼èˆªæ æ ·å¼ */
    .top-nav {
      width: 100%;
      background-color: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .logo-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      background-color: #f8f9fa;
      border-bottom: 1px solid #eee;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-img {
      height: 40px;
      width: auto;
    }

    .logo-text {
      font-size: 24px;
      font-weight: bold;
      color: #e91e63;
    }

    .language-select {
      padding: 5px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: white;
      cursor: pointer;
    }

    .nav-links {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px 20px;
      background-color: #fff;
      flex-wrap: wrap;
      gap: 20px;
    }

    .nav-links a {
      color: #333;
      text-decoration: none;
      padding: 5px 10px;
      border-radius: 4px;
      transition: background-color 0.3s;
    }

    .nav-links a:hover {
      background-color: #f0f0f0;
      color: #e91e63;
    }

    /* ä¸‹æ‹‰èœå•æ ·å¼ */
    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background-color: #fff;
      min-width: 160px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      border-radius: 4px;
      z-index: 1100;
    }

    .dropdown-content a {
      color: #333;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      text-align: left;
    }

    .dropdown-content a:hover {
      background-color: #f0f0f0;
      color: #e91e63;
    }

    .dropdown:hover .dropdown-content {
      display: block;
    }

    /* ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 768px) {
      .logo-bar {
        padding: 10px;
      }

      .logo-img {
        height: 30px;
      }

      .logo-text {
        font-size: 18px;
      }

      .nav-links {
        padding: 5px;
        gap: 10px;
        font-size: 14px;
      }
      
      .dropdown-content {
        min-width: 140px;
      }
    }

    /* åŸæœ‰æ ·å¼ç»§ç»­ä¿æŒ */
    .step { 
      display: none; 
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
    }
    .active { display: block; }
    .card-table { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-top: 10px; }
    .card-column { display: flex; flex-direction: column; align-items: center; }
    .card-label { margin-bottom: 5px; text-align: center; }
    .card-grid { display: flex; flex-direction: column; gap: 5px; width: 100%; }
    .card {
      border: 2px solid #ccc;
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      background-color: #f8f8f8;
      transition: transform 0.2s;
      width: 100px;
      position: relative;
      padding-right: 25px;
      word-break: break-word;
      hyphens: auto;
    }
    .card:hover { 
      transform: scale(1.05); 
      border-color: #007bff;
      background-color: #fff5f5;
    }
    .card .delete-icon {
      position: absolute;
      top: 2px;
      right: 2px;
      cursor: pointer;
      opacity: 0.7;
      padding: 2px;
    }
    .card .delete-icon:hover {
      opacity: 1;
    }
    .used-cards, .cup-entries, .clot-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
      padding: 10px;
      border: 1px dashed #ccc;
      border-radius: 10px;
      min-height: 60px;
    }
    .used-card, .clot-card, .cup-entry {
      padding: 5px 10px;
      background-color: #ffe;
      border-radius: 6px;
      border: 1px solid #999;
      font-size: 14px;
      cursor: pointer;
      position: relative;
      padding-right: 25px;
    }
    
    .used-card:hover, .clot-card:hover, .cup-entry:hover {
      background-color: #fff5f5;
    }
    
    .used-card .delete-icon, .clot-card .delete-icon, .cup-entry .delete-icon {
      position: absolute;
      top: 2px;
      right: 2px;
      cursor: pointer;
      opacity: 0.7;
      padding: 2px;
    }

    .used-card .delete-icon:hover, .clot-card .delete-icon:hover, .cup-entry .delete-icon:hover {
      opacity: 1;
    }
    
    button { margin-top: 20px; padding: 8px 16px; }
    label { display: block; margin-top: 10px; }
    input[type="number"] { width: 60px; }
    select { margin-bottom: 5px; }
    
    .button-container {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      width: 100%;
    }
    
    .prev-button {
      flex: 1;
      padding: 8px 16px;
    }
    
    .next-button {
      flex: 3;
      padding: 8px 16px;
    }
    
    .save-temp-button {
      width: 100%;
      margin-top: 10px;
      padding: 8px 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .save-temp-button:hover {
      background-color: #45a049;
    }
    
    .save-temp-button:active {
      background-color: #3d8b40;
    }
    
    .chart-container {
      width: 100%;
      max-width: 1000px;
      margin: 20px auto;
      display: flex;
      gap: 20px;
    }
    .chart-wrapper {
      flex: 1;
      min-width: 0;
    }
    .chart-wrapper.pie-chart {
      flex: 0 0 300px;
    }
    
    /* æ–‡æœ¬æ¡†æ ·å¼ */
    .message-box {
      margin: 20px auto;
      padding: 15px 20px;
      background-color: #fff5f5;
      border: 1px solid #ffcdd2;
      border-radius: 8px;
      text-align: center;
      color: #d32f2f;
      font-size: 14px;
      line-height: 1.4;
      max-width: 400px;
    }

    .probability-box {
      margin: 15px auto;
      padding: 12px 20px;
      background-color: #f3e5f5;
      border: 1px solid #ce93d8;
      border-radius: 8px;
      text-align: center;
      color: #6a1b9a;
      font-size: 15px;
      line-height: 1.4;
      max-width: 400px;
    }

    .suggestion-box {
      margin: 15px auto;
      padding: 12px 20px;
      background-color: #e8f5e9;
      border: 1px solid #a5d6a7;
      border-radius: 8px;
      text-align: center;
      color: #2e7d32;
      font-size: 15px;
      line-height: 1.4;
      max-width: 400px;
    }
    
    @media (max-width: 768px) {
      body {
        padding: 10px 0;
        max-width: 100%;
        font-size: 14px;
      }
      
      .step {
        padding: 0 10px;
      }
      
      h2 {
        font-size: 1.5em;
        margin: 10px 0;
        padding: 0 10px;
      }
      
      .chart-container {
        margin: 10px 0;
        padding: 0;
        gap: 15px;
        flex-direction: column;
        align-items: center;
      }
      
      .chart-wrapper {
        width: 100%;
        padding: 0 10px;
        box-sizing: border-box;
      }
      
      .chart-wrapper.bar-chart {
        min-height: 250px;
      }
      
      .chart-wrapper.pie-chart {
        width: 75%;
        min-height: 250px;
      }
      
      table {
        margin: 0 10px;
        width: calc(100% - 20px);
        font-size: 12px;
      }
      
      td, th {
        padding: 4px;
      }
      
      .card-table {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        padding: 0 10px;
      }
      
      .card {
        width: auto;
        min-height: 40px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        font-size: 12px;
        line-height: 1.2;
        padding: 5px 25px 5px 5px;
      }
      
      .card-info {
        display: flex;
        flex-direction: column;
        gap: 0px;
      }
      
      .card .delete-icon {
        top: 50%;
        right: 5px;
        transform: translateY(-50%);
      }
      
      select, input[type="number"] {
        font-size: 16px; /* é˜²æ­¢iOSè‡ªåŠ¨æ”¾å¤§ */
        padding: 8px;
      }
      
      button {
        font-size: 16px;
        padding: 10px 20px;
        width: 100%;
        margin: 10px 0;
      }
      
      .message-box, .probability-box, .suggestion-box {
        margin: 15px 10px;
        padding: 12px 15px;
        font-size: 13px;
      }
    }

    /* è¡€å—å¡ç‰‡å®¹å™¨æ ·å¼ */
    .clot-container {
      margin-top: 20px;
    }
    
    .clot-container h3 {
      margin-bottom: 10px;
    }
    
    .clot-card-table {
      display: grid;
      grid-template-columns: repeat(3, 1fr) !important;
      gap: 10px;
      padding: 0 10px;
    }

    @media (max-width: 768px) {
      .clot-card-table .card {
        min-height: 35px;
        padding: 5px 25px 5px 5px;
      }
    }

    .date-display {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 14px;
      color: #666;
    }
    
    .save-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 20px auto;
      padding: 0 10px;
    }
    
    .save-button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }
    
    .save-image {
      background-color: #e3f2fd;
      color: #1565c0;
    }
    
    .save-pdf {
      background-color: #fce4ec;
      color: #c2185b;
    }
    
    .save-button:hover {
      opacity: 0.9;
    }
    
    /* æ¶‚æŠ¹æ¨¡å¼ç›¸å…³æ ·å¼ */
    .paint-mode-btn {
      padding: 8px 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .pad-type-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .pad-add-btn {
      flex: 1;
      min-width: 100px;
      padding: 8px 16px;
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .pad-add-btn:hover {
      background-color: #1976D2;
    }
    
    .pad-canvas-container {
      position: relative;
      width: 200px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      overflow: hidden;
      padding-bottom: 40px;
    }
    
    .pad-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 8px;
      background: #f5f5f5;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      align-items: center;
    }
    
    .pad-info select {
      flex: 1;
      min-width: 60px;
      padding: 4px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    
    .pad-info span {
      font-size: 14px;
      color: #666;
    }

    .saved-volume {
      width: 100%;
      text-align: center;
      color: #e91e63 !important;
      font-weight: bold;
      padding-top: 5px;
      border-top: 1px dashed #ccc;
    }
    
    .paint-controls {
      margin: 15px 0;
      padding: 15px;
      background-color: #f5f5f5;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .paint-color-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .pads-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }
    
    .pad-canvas {
      display: block;
      background: #fff;
    }
    
    .pad-canvas-container .delete-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(255, 0, 0, 0.8);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      z-index: 1;
    }
    
    .pad-canvas-container .save-btn {
      position: absolute;
      bottom: 5px;
      right: 5px;
      background: rgba(76, 175, 80, 0.8);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 12px;
      z-index: 1;
    }
    
    @media (max-width: 768px) {
      .paint-controls {
        padding: 10px;
      }
      
      .pad-canvas-container {
        width: 150px;
      }
      
      .paint-color-controls {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .paint-color-controls input[type="range"] {
        width: 100%;
      }
    }

    /* QR Code Popup Styles */
    .nav-link-container {
      position: relative; /* Needed for absolute positioning of the popup */
      display: inline-block; /* Keep links inline but allow relative positioning */
    }

    .qr-popup {
      display: none; /* Hidden by default */
      position: absolute;
      top: 100%; /* Position below the link */
      left: 50%;
      transform: translateX(-50%); /* Center horizontally */
      margin-top: 5px; /* Space between link and popup */
      background-color: white;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      text-align: center;
      z-index: 1100; /* Ensure it's above other content */
      white-space: nowrap; /* Prevent wrapping */
    }

    .qr-popup img {
      display: block;
      max-width: 100px; /* Adjust size as needed */
      height: auto;
      margin-bottom: 5px;
    }

    .qr-popup span {
      font-size: 12px;
      color: #555;
    }

    /* Show popup on hover */
    .nav-link-container:hover .qr-popup {
      display: block;
    }

    .message-box-container {
      max-width: 100%;
      padding: 15px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
      box-sizing: border-box;
    }

    .message-box {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      width: 100%;
      box-sizing: border-box;
      max-width: 800px;
      margin: 0 auto;
    }

    .message-box p {
      margin-bottom: 10px;
      line-height: 1.6;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    @media (max-width: 768px) {
      .message-box-container {
        padding: 10px;
        width: 100%;
      }

      .message-box {
        padding: 15px;
        width: 100%;
        max-width: 100%;
      }

      .message-box p {
        font-size: 14px;
      }
    }

    .qr-code-trigger {
      color: #007bff;
      cursor: pointer;
      text-decoration: underline;
    }

    .qr-code-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
    }

    .qr-code-content {
      position: relative;
      background-color: white;
      margin: 15% auto;
      padding: 20px;
      width: 300px;
      border-radius: 8px;
    }

    .close-modal {
      position: absolute;
      right: 10px;
      top: 5px;
      font-size: 24px;
      cursor: pointer;
    }

    .image-section {
      text-align: center;
      margin: 30px 0;
    }

    .responsive-image {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .download-btn {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }

    .download-btn:hover {
      background-color: #218838;
    }

    @media (max-width: 768px) {
      .message-box {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <nav class="top-nav">
    <div class="logo-bar">
      <div class="logo-container">
        <img src="logo.png" alt="è¡€å‹å§å¦¹ä¼š" class="logo-img">
        <a href="http://47.122.118.186/home" style="text-decoration: none;"><span class="logo-text">è¡€å‹å§å¦¹ä¼š</span></a>
      </div>
      <select class="language-select" onchange="changeLanguage(this.value)">
        <option value="zh">ä¸­æ–‡</option>
        <option value="en">English</option>
      </select>
    </div>
    <div class="nav-links">
      <a href="http://47.122.118.186/home">ä¸»é¡µ</a>
      <div class="dropdown">
        <a href="#">ç§‘æ™®</a>
        <div class="dropdown-content">
          <a href="http://47.122.118.186/education">ç§‘æ™®å›¾æ–‡</a>
          <a href="http://47.122.118.186/video">è§†é¢‘æ’­æ”¾</a>
          <a href="http://47.122.118.186/file">èµ„æ–™ä¸‹è½½</a>
        </div>
      </div>
      <a href="http://47.122.118.186/map">æ£€æµ‹åœ°å›¾</a>
      <div class="nav-link-container">
        <a href="https://lxi.me/3Xr9Bq">é—®å·è·³è½¬</a>
        <div class="qr-popup">
          <img src="qrcode.png" alt="é—®å·äºŒç»´ç ">
          <span>è¡€å‹ç—…å¥³æ€§å‡ºè¡€è¯„ä¼°</span>


        </div>

      </div>
      <a href="http://47.122.118.186/period">æœˆç»ä¼°ç®—</a>
      <a href="http://47.122.118.186/news">æ–°é—»</a>
      <a href="http://47.122.118.186/contact">è”ç³»æ–¹å¼</a>
    </div>
  </nav>

  <!-- æ·»åŠ è¯­è¨€åˆ‡æ¢åŠŸèƒ½çš„è„šæœ¬ -->
  <script>
    function changeLanguage(lang) {
      // è¿™é‡Œå¯ä»¥æ·»åŠ è¯­è¨€åˆ‡æ¢çš„å…·ä½“å®ç°
      console.log('Language changed to:', lang);
      // TODO: å®ç°å…·ä½“çš„è¯­è¨€åˆ‡æ¢é€»è¾‘
    }
  </script>

  <!-- ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©æœˆç»å¤©æ•°å’Œç”¨å“ -->
  <div id="step1" class="step active">
    <h2>æœˆç»å‡ºè¡€é‡è¯„ä¼°å·¥å…·PBACäº¤äº’ç‰ˆ</h2>
    <h2>é€‰æ‹©æœˆç»ç”¨å“å’Œå¤©æ•°</h2>
    <label>è¯·é€‰æ‹©æœˆç»å¤©æ•°ï¼š
      <select id="periodDays">
        <option value="1">1 å¤©</option><option value="2">2 å¤©</option><option value="3">3 å¤©</option>
        <option value="4">4 å¤©</option><option value="5" selected>5 å¤©</option><option value="6">6 å¤©</option>
        <option value="7">7 å¤©</option><option value="8">8 å¤©</option><option value="9">9 å¤©</option><option value="10">10 å¤©</option>
      </select>
    </label>
    <label><input type="checkbox" id="usePad" checked> ä½¿ç”¨å«ç”Ÿå·¾</label>
    <label><input type="checkbox" id="useTampon"> ä½¿ç”¨æ£‰æ¡</label>
    <label><input type="checkbox" id="useCup"> ä½¿ç”¨æœˆç»æ¯</label>
    <button onclick="startTracking()">å¼€å§‹è®°å½•</button>
  </div>


  
  <div class="message-box-container">
    <div class="message-box">
      <p>å¼€å‘è€…å°çº¢ä¹¦ï¼š<a href="https://www.xiaohongshu.com/user/profile/661948f90000000007007e07" target="qrcode.png">è¡€å‹å§å¦¹ä¼š</a></p>
      <p>å¼€å‘è€…å¾®ä¿¡ï¼šWGH38417</p>
      <p>æœ¬å·¥å…·ç›®å‰ä¸ºå¼€æºé¡¹ç›®ï¼Œå…è´¹æä¾›ä½¿ç”¨ï¼Œç¦æ­¢ç”¨äºç›ˆåˆ©æˆ–å•†ä¸šç”¨é€”ã€‚</p>
      <p>è¯¥å·¥å…·ä¸ºé™æ€ç½‘é¡µï¼Œä¸ä¼šä¸Šä¼ æˆ–å­˜å‚¨ç”¨æˆ·æ•°æ®ã€‚"æš‚å­˜"åŠŸèƒ½æœªä½¿ç”¨ Cookiesï¼Œè€Œæ˜¯é€šè¿‡æµè§ˆå™¨çš„ Local Storage å®ç°ã€‚</p>
      <p>æœˆç»å‡ºè¡€é‡è¯„ä¼°å·¥å…·PBACäº¤äº’ç‰ˆï¼ˆæœ¬é¡µé¢ï¼‰ï¼š<a href="http://47.122.118.186/period/" target="_blank">http://47.122.118.186/period/</a></p>
      
      <p>æœˆç»å‡ºè¡€é‡è¯„ä¼°å·¥å…·PBACé—®å·ç‰ˆï¼š<a href="https://lxi.me/eZGwd3" target="https://lxi.me/eZGwd3">https://lxi.me/eZGwd3</a></p>

      <p>æœˆç»å‡ºè¡€é‡è¯„ä¼°å·¥å…·PBACå›¾ç‰‡ç‰ˆå’Œè¡¨æ ¼ç‰ˆï¼šè§ä¸‹æ–¹ğŸ‘‡</p>
    </div>

    <div class="image-section">
      <img src="pbac/pbac.png" alt="ç›¸å…³å›¾ç‰‡" class="responsive-image">
      <button class="download-btn" onclick="downloadFile()">
        <i class="fas fa-download"></i> ä¸‹è½½Excelè¡¨æ ¼æ–‡ä»¶ç‰ˆ
      </button>
    </div>
    <div class="message-box">
      <p>å·¥å…·åŸºäº PBACï¼ˆPictorial Blood loss Assessment Toolï¼‰è®¾è®¡ï¼Œæ‰€æä¾›çš„ä¼°ç®—ç»“æœä»…ä¾›å‚è€ƒã€‚</p>
      <p>æœ¬å·¥å…·æ—¨åœ¨å¸®åŠ©å§å¦¹è®°å½•ç»æœŸæƒ…å†µï¼Œåœ¨ä¸åŒ»ç–—æœåŠ¡æä¾›è€…äº¤æµæ—¶æä¾›å‚è€ƒï¼Œä¸æ„æˆåŒ»ç–—å»ºè®®ã€‚</p>
      <p>è¯¥å·¥å…·åœ¨1990å¹´ç”±Jenny M. HIGHAMç­‰[3]å‘æ˜ï¼Œç”±å°çº¢ä¹¦@è¡€å‹å§å¦¹ä¼š ç¿»è¯‘ã€‚</p>
    </div>
    <div class="message-box">
      <p>è‹¥æ‚¨æ€»åˆ† â‰¥100ï¼Œæç¤ºå¾ˆæœ‰å¯èƒ½æœˆç»è¿‡å¤šã€‚</p>
      <p>æ­£å¸¸å¥³æ€§æœˆç»é‡æ˜¯20-60mLã€‚æœˆç»è¿‡å¤šï¼ˆHMBï¼‰å®šä¹‰ä¸ºï¼šå‡ºè¡€æŒç»­è¶…è¿‡7å¤©ï¼Œæˆ–æ¯æ¬¡æœˆç»å¤±è¡€é‡è¶…è¿‡80æ¯«å‡ã€‚</p>
    </div>
    <div class="message-box">
      <p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒPBACä¼°ç®—æœ‰å±€é™æ€§ï¼Œè‹¥æ‚¨ä¼°è®¡ç»“æœåœ¨20-60mLä¸€èˆ¬å¯è®¤ä¸ºæ‚¨æœˆç»é‡æ­£å¸¸ï¼›è‹¥æ‚¨ä¼°è®¡ç»“æœåœ¨100mLä»¥ä¸Šä¸€èˆ¬è®¤ä¸ºæ‚¨æœˆç»é‡è¿‡å¤šï¼›</p>
      <p>ä½†å¦‚æœåœ¨60-100mLï¼Œæˆ–è®¸ä¸èƒ½åšå‡ºå¾ˆå¥½çš„åˆ¤æ–­ï¼Œéœ€è¦ç§°é‡æ–¹æ³•æ‰èƒ½ç²¾å‡†ç¡®å®šã€‚</p>
      <p>å°½ç®¡å¦‚æ­¤ï¼ŒPBACä»ç„¶æ˜¯ç›®å‰æœˆç»ç›¸å…³ç§‘ç ”ä¸­ä½¿ç”¨æœ€å¹¿æ³›ã€ç›¸å…³æ•°æ®æœ€å¤šçš„ä¸€ä¸ªå·¥å…·ã€‚</p>
      <p>å¹¶ä¸”æœ¬å·¥å…·ç°æœ‰çš„æ•°å€¼å¹¶æœªç»è¿‡å¤§é‡çš„çœŸå®æ•°æ®è¾…åŠ©éªŒè¯ï¼Œæˆ‘ä»¬éå¸¸æ¬¢è¿æ‚¨åˆ†äº«è‡ªå·±çš„"ç§°é‡å¢é‡"å’Œ"æŸ“è¡€ç¨‹åº¦"ä¿¡æ¯ï¼Œå¸®åŠ©ä¼˜åŒ–æ•°å€¼ã€‚(å¾®ä¿¡WGH38417)</p>
    </div>
    <div class="message-box">
      <p>è¶…è¿‡10%çš„å¥³æ€§è‡ªè®¤ä¸ºæœˆç»æ­£å¸¸ï¼Œä½†PBACè¯„åˆ†â‰¥100ï¼Œä¸”ä¼´æœ‰ç¼ºé“æ€§è´«è¡€[1]ã€‚</p>
      <p>PBACæ€»åˆ†â‰¥100ï¼Œä¸é—ä¼ æ€§å‡ºè¡€æ€§ç–¾ç—…ï¼ˆåŒ…æ‹¬è¡€å‹ç—…Aå’ŒBã€vWDã€ç½•è§å‡è¡€å› å­ç¼ºä¹ï¼‰å‘ˆé«˜åº¦ç›¸å…³ï¼Œ</p>
      <p>æ€»åˆ†â‰¥100çš„äººé‡Œæœ‰65%å­˜åœ¨å‡è¡€å¼‚å¸¸[2]ã€‚</p>
    </div>

    <div class="message-box">
      <p>è‹¥æ‚¨çš„å¡«å†™ç»“æœæ˜¾ç¤ºâ‰¥100 æç¤ºå¾ˆæœ‰å¯èƒ½æœˆç»è¿‡å¤šï¼Œå»ºè®®è¿›ä¸€æ­¥å¡«å†™ï¼š</p>
      <p>æœˆç»å‡ºè¡€é—®å·PBQé—®å·ç‰ˆï¼š<a href="https://lxi.me/2g2Rxu" target="https://lxi.me/2g2Rxu">https://lxi.me/2g2Rxu</a></p>
      <p>å‡ºè¡€è¯„ä¼°é—®å·BATï¼š<a href="https://lxi.me/4CXHv0" target="https://lxi.me/4CXHv0">https://lxi.me/4CXHv0</a></p>
      <p>å»ºè®®å‰å¾€åŒ»é™¢æ£€æµ‹è¡€çº¢è›‹ç™½ã€é“è›‹ç™½ï¼ˆå› ä¸ºä½ å¾ˆæœ‰å¯èƒ½ç¼ºé“æ€§è´«è¡€ï¼Œè€Œé“è›‹ç™½ä½äº30å¯èƒ½æ˜¯è„±å‘ã€ç–²åŠ³ã€å¤´æ™•ã€æ‰‹è„šå†°å‡‰ã€ç¡çœ éšœç¢ã€æœˆç»ä¸è°ƒç­‰ç—‡çŠ¶çš„åŸå› ï¼‰</p>
      <p>æ£€æµ‹å‡è¡€å››é¡¹ã€å‡è¡€å› å­ã€vwfå› å­ï¼ˆå› ä¸ºæœ‰ä¸€å®šçš„å¯èƒ½æ€§å­˜åœ¨å‡è¡€åŠŸèƒ½å¼‚å¸¸ BATâ‰¥6åˆ†å¯æŒ‡ç¤ºå‡è¡€éšœç¢ï¼‰ã€‚</p>
    </div>

    <div class="message-box">
      <p>å‚è€ƒæ–‡çŒ®</p>
      <p>[1]KO J K, LAO T T, CHEUNG V Y, 2021. Pictorial Blood Loss Assessment Chart for evaluating heavy menstrual bleeding in Asian women[J/OL]. Hong Kong Medical Journal, 27(6): 399-404[2022-11-18]. https://www.hkmj.org/system/files/hkmj208743.pdf. DOI:https://doi.org/10.12809/hkmj208743.</p>
      <p>[2]HALIMEH S, ROTT H, KAPPERT G, ç­‰, 2013. Establishment Of a Reference Range For The Pbac-Score[J/OL]. Blood, 122(21): 4772-4772[2020-10-04]. DOI:https://doi.org/10.1182/blood.v122.21.4772.4772.</p>
      <p>[3]HIGHAM J M, O'BRIEN P M S, SHAW R W, 1990. Assessment of menstrual blood loss using a pictorial chart[J/OL]. BJOG: An International Journal of Obstetrics and Gynaecology, 97(8): 734-739. DOI:https://doi.org/10.1111/j.1471-0528.1990.tb16249.x.</p>
    </div>
  </div>
</div>
  <div class="qr-code-modal" id="qrCodeModal">
    <div class="qr-code-content">
      <span class="close-modal">&times;</span>
      <div id="qrcode"></div>
    </div>
  </div>

  <!-- ç¬¬äºŒæ­¥ï¼šè®°å½•æ¯ä¸€å¤©çš„ç”¨å“ä½¿ç”¨ -->
  <div id="tracker" class="step">
    <h2>ç¬¬ <span id="currentDay">1</span> å¤©</h2>
    <div id="productSection"></div>
    <div class="button-container">
      <button class="prev-button" onclick="prevDay()" id="prevDayBtn" disabled>ä¸Šä¸€å¤©</button>
      <button class="next-button" onclick="nextDay()">ä¸‹ä¸€å¤©</button>
    </div>
    <button class="save-temp-button" onclick="saveTemp()">æš‚å­˜æ•°æ®</button>
  </div>

  <!-- ç¬¬ä¸‰æ­¥ï¼šå±•ç¤ºç»Ÿè®¡ç»“æœ -->
  <div id="result" class="step">
    <div class="date-display"></div>
    <h2>å‡ºè¡€é‡ç»Ÿè®¡ç»“æœ</h2>
    <p>æ€»ä¼°è®¡å‡ºè¡€é‡ï¼š<span id="totalVolume"></span> ml</p>
    <div class="probability-box">æ‚¨æœ‰æœˆç»å‡ºè¡€è¿‡å¤šçš„æ¦‚ç‡æ˜¯ <span id="probability"></span>%</div>
    <div class="suggestion-box"><span id="suggestion"></span></div>
    <div class="message-box">è°¢è°¢æ‚¨çš„ä½¿ç”¨ã€‚ä¼°ç®—ç»“æœä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆåŒ»ç–—å»ºè®®ï¼Œå¦‚æœ‰ä»»ä½•å¥åº·ç–‘é—®ï¼Œè¯·å’¨è¯¢ä¸“ä¸šåŒ»ç”Ÿã€‚</div>
    <div class="chart-container">
      <div class="chart-wrapper bar-chart">
        <canvas id="barChart"></canvas>
      </div>
      <div class="chart-wrapper pie-chart">
        <canvas id="pieChart"></canvas>
      </div>
    </div>
    <table border="1" cellpadding="5">
      <thead>
        <tr>
          <th>å¤©æ•°</th>
          <th>ç”¨å“æ•°é‡</th>
          <th>ä¼°è®¡å‡ºè¡€é‡ (ml)</th>
          <th>è¯¦æƒ…</th>
        </tr>
      </thead>
      <tbody id="resultTable"></tbody>
    </table>
    <div class="save-buttons">
      <button class="save-button save-image" onclick="saveAsImage()">ä¿å­˜æŠ¥å‘Šä¸ºå›¾ç‰‡</button>
      <button class="save-button save-pdf" onclick="saveAsPDF()">ä¿å­˜æŠ¥å‘Šä¸ºPDF</button>
    </div>
    <div class="message-box">
      <p>è‹¥æ‚¨çš„å¡«å†™ç»“æœæ˜¾ç¤ºâ‰¥100 æç¤ºå¾ˆæœ‰å¯èƒ½æœˆç»è¿‡å¤šï¼Œå»ºè®®è¿›ä¸€æ­¥å¡«å†™ï¼š</p>
      <p>æœˆç»å‡ºè¡€é—®å·PBQé—®å·ç‰ˆï¼š<a href="https://lxi.me/2g2Rxu" target="https://lxi.me/2g2Rxu">https://lxi.me/2g2Rxu</a></p>
      <p>å‡ºè¡€è¯„ä¼°é—®å·BATï¼š<a href="https://lxi.me/4CXHv0" target="https://lxi.me/4CXHv0">https://lxi.me/4CXHv0</a></p>
      <p>å»ºè®®å‰å¾€åŒ»é™¢æ£€æµ‹è¡€çº¢è›‹ç™½ã€é“è›‹ç™½ï¼ˆå› ä¸ºä½ å¾ˆæœ‰å¯èƒ½ç¼ºé“æ€§è´«è¡€ï¼Œè€Œé“è›‹ç™½ä½äº30å¯èƒ½æ˜¯è„±å‘ã€ç–²åŠ³ã€å¤´æ™•ã€æ‰‹è„šå†°å‡‰ã€ç¡çœ éšœç¢ã€æœˆç»ä¸è°ƒç­‰ç—‡çŠ¶çš„åŸå› ï¼‰</p>
      <p>æ£€æµ‹å‡è¡€å››é¡¹ã€å‡è¡€å› å­ã€vwfå› å­ï¼ˆå› ä¸ºæœ‰ä¸€å®šçš„å¯èƒ½æ€§å­˜åœ¨å‡è¡€åŠŸèƒ½å¼‚å¸¸ BATâ‰¥6åˆ†å¯æŒ‡ç¤ºå‡è¡€éšœç¢ï¼‰ã€‚</p>
    </div>
    <div class="message-box">
      <p>å·¥å…·åŸºäº PBACï¼ˆPictorial Blood loss Assessment Toolï¼‰è®¾è®¡ï¼Œæ‰€æä¾›çš„ä¼°ç®—ç»“æœä»…ä¾›å‚è€ƒã€‚</p>
      <p>æœ¬å·¥å…·æ—¨åœ¨å¸®åŠ©å§å¦¹è®°å½•ç»æœŸæƒ…å†µï¼Œåœ¨ä¸åŒ»ç–—æœåŠ¡æä¾›è€…äº¤æµæ—¶æä¾›å‚è€ƒï¼Œä¸æ„æˆåŒ»ç–—å»ºè®®ã€‚</p>
      <p>è¯¥å·¥å…·åœ¨1990å¹´ç”±Jenny M. HIGHAMç­‰[3]å‘æ˜ï¼Œç”±å°çº¢ä¹¦@è¡€å‹å§å¦¹ä¼š ç¿»è¯‘ã€‚</p>
    </div>
    <div class="message-box">
      <p>æ­£å¸¸å¥³æ€§æœˆç»é‡æ˜¯20-60mLã€‚æœˆç»è¿‡å¤šï¼ˆHMBï¼‰å®šä¹‰ä¸ºï¼šå‡ºè¡€æŒç»­è¶…è¿‡7å¤©ï¼Œæˆ–æ¯æ¬¡æœˆç»å¤±è¡€é‡è¶…è¿‡80æ¯«å‡ã€‚</p>
    </div>
    <div class="message-box">
      <p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒPBACä¼°ç®—æœ‰å±€é™æ€§ï¼Œè‹¥æ‚¨ä¼°è®¡ç»“æœåœ¨20-60mLä¸€èˆ¬å¯è®¤ä¸ºæ‚¨æœˆç»é‡æ­£å¸¸ï¼›è‹¥æ‚¨ä¼°è®¡ç»“æœåœ¨100mLä»¥ä¸Šä¸€èˆ¬è®¤ä¸ºæ‚¨æœˆç»é‡è¿‡å¤šï¼›</p>
      <p>ä½†å¦‚æœåœ¨60-100mLï¼Œæˆ–è®¸ä¸èƒ½åšå‡ºå¾ˆå¥½çš„åˆ¤æ–­ï¼Œéœ€è¦ç§°é‡æ–¹æ³•æ‰èƒ½ç²¾å‡†ç¡®å®šã€‚</p>
      <p>å°½ç®¡å¦‚æ­¤ï¼ŒPBACä»ç„¶æ˜¯ç›®å‰æœˆç»ç›¸å…³ç§‘ç ”ä¸­ä½¿ç”¨æœ€å¹¿æ³›ã€ç›¸å…³æ•°æ®æœ€å¤šçš„ä¸€ä¸ªå·¥å…·ã€‚</p>
      <p>å¹¶ä¸”æœ¬å·¥å…·ç°æœ‰çš„æ•°å€¼å¹¶æœªç»è¿‡å¤§é‡çš„çœŸå®æ•°æ®è¾…åŠ©éªŒè¯ï¼Œæˆ‘ä»¬éå¸¸æ¬¢è¿æ‚¨åˆ†äº«è‡ªå·±çš„"ç§°é‡å¢é‡"å’Œ"æŸ“è¡€ç¨‹åº¦"ä¿¡æ¯ï¼Œå¸®åŠ©ä¼˜åŒ–æ•°å€¼ã€‚(å¾®ä¿¡WGH38417)</p>
    </div>
    <div class="message-box">
      <p>è¶…è¿‡10%çš„å¥³æ€§è‡ªè®¤ä¸ºæœˆç»æ­£å¸¸ï¼Œä½†PBACè¯„åˆ†â‰¥100ï¼Œä¸”ä¼´æœ‰ç¼ºé“æ€§è´«è¡€[1]ã€‚</p>
      <p>PBACæ€»åˆ†â‰¥100ï¼Œä¸é—ä¼ æ€§å‡ºè¡€æ€§ç–¾ç—…ï¼ˆåŒ…æ‹¬è¡€å‹ç—…Aå’ŒBã€vWDã€ç½•è§å‡è¡€å› å­ç¼ºä¹ï¼‰å‘ˆé«˜åº¦ç›¸å…³ï¼Œ</p>
      <p>æ€»åˆ†â‰¥100çš„äººé‡Œæœ‰65%å­˜åœ¨å‡è¡€å¼‚å¸¸[2]ã€‚</p>
    </div>
    <div class="message-box">
      <p>å‚è€ƒæ–‡çŒ®</p>
      <p>[1]KO J K, LAO T T, CHEUNG V Y, 2021. Pictorial Blood Loss Assessment Chart for evaluating heavy menstrual bleeding in Asian women[J/OL]. Hong Kong Medical Journal, 27(6): 399-404[2022-11-18]. https://www.hkmj.org/system/files/hkmj208743.pdf. DOI:https://doi.org/10.12809/hkmj208743.</p>
      <p>[2]HALIMEH S, ROTT H, KAPPERT G, ç­‰, 2013. Establishment Of a Reference Range For The Pbac-Score[J/OL]. Blood, 122(21): 4772-4772[2020-10-04]. DOI:https://doi.org/10.1182/blood.v122.21.4772.4772.</p>
      <p>[3]HIGHAM J M, O'BRIEN P M S, SHAW R W, 1990. Assessment of menstrual blood loss using a pictorial chart[J/OL]. BJOG: An International Journal of Obstetrics and Gynaecology, 97(8): 734-739. DOI:https://doi.org/10.1111/j.1471-0528.1990.tb16249.x.</p>
    </div>


  </div>

  <script>
    // æ³¨å†ŒChart.jsæ•°æ®æ ‡ç­¾æ’ä»¶
    Chart.register(ChartDataLabels);

    // å„ç±»ç”¨å“æ•°æ®å®šä¹‰
    const padTypes = ['æ—¥ç”¨', 'å¤œç”¨', 'å®‰å¿ƒè£¤', 'æŠ¤å«'];
    const tamponTypes = ['è¿·ä½ ', 'å¸¸è§„', 'å¤§å·', 'åŠ å¤§'];
    const saturationLevels = ['æŸ“äº†ä¸€ç‚¹', 'æŸ“äº†ä¸€åŠ', 'å…¨æŸ“çº¢'];
    const padVolumes = {
      'æ—¥ç”¨': {
        'çŸ­': { 'æŸ“äº†ä¸€ç‚¹': 1, 'æŸ“äº†ä¸€åŠ': 4, 'å…¨æŸ“çº¢': 15, 'maxCapacity': 15 },
        'ä¸­': { 'æŸ“äº†ä¸€ç‚¹': 1, 'æŸ“äº†ä¸€åŠ': 5, 'å…¨æŸ“çº¢': 20, 'maxCapacity': 20 },
        'é•¿': { 'æŸ“äº†ä¸€ç‚¹': 2, 'æŸ“äº†ä¸€åŠ': 7, 'å…¨æŸ“çº¢': 25, 'maxCapacity': 25 }
      },
      'å¤œç”¨': {
        'çŸ­': { 'æŸ“äº†ä¸€ç‚¹': 1, 'æŸ“äº†ä¸€åŠ': 5, 'å…¨æŸ“çº¢': 20, 'maxCapacity': 20 },
        'ä¸­': { 'æŸ“äº†ä¸€ç‚¹': 2, 'æŸ“äº†ä¸€åŠ': 6, 'å…¨æŸ“çº¢': 25, 'maxCapacity': 25 },
        'é•¿': { 'æŸ“äº†ä¸€ç‚¹': 2, 'æŸ“äº†ä¸€åŠ': 7, 'å…¨æŸ“çº¢': 30, 'maxCapacity':30 }
      },
      'å®‰å¿ƒè£¤': {
        'çŸ­': { 'æŸ“äº†ä¸€ç‚¹': 1.5, 'æŸ“äº†ä¸€åŠ': 6, 'å…¨æŸ“çº¢': 30, 'maxCapacity': 30 },
        'ä¸­': { 'æŸ“äº†ä¸€ç‚¹': 2, 'æŸ“äº†ä¸€åŠ': 7, 'å…¨æŸ“çº¢': 35, 'maxCapacity': 35 },
        'é•¿': { 'æŸ“äº†ä¸€ç‚¹': 2, 'æŸ“äº†ä¸€åŠ': 8, 'å…¨æŸ“çº¢': 40, 'maxCapacity': 40 }
      },
      'æŠ¤å«': {
        'çŸ­': { 'æŸ“äº†ä¸€ç‚¹': 0.5, 'æŸ“äº†ä¸€åŠ': 1, 'å…¨æŸ“çº¢': 5, 'maxCapacity': 5 },
        'ä¸­': { 'æŸ“äº†ä¸€ç‚¹': 0.5, 'æŸ“äº†ä¸€åŠ': 2, 'å…¨æŸ“çº¢': 10, 'maxCapacity': 10 },
        'é•¿': { 'æŸ“äº†ä¸€ç‚¹': 0.5, 'æŸ“äº†ä¸€åŠ': 3, 'å…¨æŸ“çº¢': 15, 'maxCapacity': 15 }
      }
    };
    const tamponVolumes = {
      'è¿·ä½ ': {
        'ä½': { 'æŸ“äº†ä¸€ç‚¹': 0.5, 'æŸ“äº†ä¸€åŠ': 5, 'å…¨æŸ“çº¢': 5 },
        'ä¸­': { 'æŸ“äº†ä¸€ç‚¹': 0.5, 'æŸ“äº†ä¸€åŠ': 10, 'å…¨æŸ“çº¢': 10 },
        'é«˜': { 'æŸ“äº†ä¸€ç‚¹': 0.5, 'æŸ“äº†ä¸€åŠ': 15, 'å…¨æŸ“çº¢': 15 }
      },
      'å¸¸è§„': {
        'ä½': { 'æŸ“äº†ä¸€ç‚¹': 1, 'æŸ“äº†ä¸€åŠ': 4, 'å…¨æŸ“çº¢': 15 },
        'ä¸­': { 'æŸ“äº†ä¸€ç‚¹': 1, 'æŸ“äº†ä¸€åŠ': 5, 'å…¨æŸ“çº¢': 20},
        'é«˜': { 'æŸ“äº†ä¸€ç‚¹': 2, 'æŸ“äº†ä¸€åŠ': 7, 'å…¨æŸ“çº¢': 25 }
      },
      'å¤§å·': {
        'ä½': { 'æŸ“äº†ä¸€ç‚¹': 1, 'æŸ“äº†ä¸€åŠ': 5, 'å…¨æŸ“çº¢': 20},
        'ä¸­': { 'æŸ“äº†ä¸€ç‚¹': 2, 'æŸ“äº†ä¸€åŠ': 6, 'å…¨æŸ“çº¢': 25 },
        'é«˜': { 'æŸ“äº†ä¸€ç‚¹': 2, 'æŸ“äº†ä¸€åŠ': 7, 'å…¨æŸ“çº¢': 30 }
      },
      'åŠ å¤§': {
        'ä½': { 'æŸ“äº†ä¸€ç‚¹': 1.5, 'æŸ“äº†ä¸€åŠ': 6, 'å…¨æŸ“çº¢': 30},
        'ä¸­': { 'æŸ“äº†ä¸€ç‚¹': 2, 'æŸ“äº†ä¸€åŠ': 7, 'å…¨æŸ“çº¢': 35},
        'é«˜': { 'æŸ“äº†ä¸€ç‚¹': 2, 'æŸ“äº†ä¸€åŠ': 8, 'å…¨æŸ“çº¢': 40}
      },
    };

    const clotOptions = [
      { label: "å°è¡€å—", volume: 1 },
      { label: "ä¸­è¡€å—", volume: 5 },
      {label:"è¡€å´©", volume:5}

    ];

    // çŠ¶æ€å˜é‡
    let currentDay = 1;
    let totalDays = 5;
    let data = [];

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰æš‚å­˜æ•°æ®
    window.onload = function() {
      const savedData = localStorage.getItem('menstrualData');
      if (savedData) {
        const parsed = JSON.parse(savedData);
        if (confirm('æ£€æµ‹åˆ°æš‚å­˜çš„æ•°æ®ï¼Œæ˜¯å¦è¦æ¢å¤ï¼Ÿ')) {
          data = parsed.data;
          currentDay = parsed.currentDay;
          totalDays = parsed.totalDays;
          
          // æ¢å¤å¤é€‰æ¡†çŠ¶æ€
          document.getElementById('usePad').checked = parsed.usePad;
          document.getElementById('useTampon').checked = parsed.useTampon;
          document.getElementById('useCup').checked = parsed.useCup;
          
          // å¦‚æœåœ¨ç¬¬ä¸€æ­¥ï¼Œç›´æ¥è·³è½¬åˆ°è¿½è¸ªç•Œé¢
          if (document.getElementById('step1').classList.contains('active')) {
            document.getElementById('step1').classList.remove('active');
            document.getElementById('tracker').classList.add('active');
          }
          
          // æ›´æ–°ç•Œé¢
          showDay();
          // æ›´æ–°æ‰€æœ‰ç±»å‹çš„å·²ä½¿ç”¨å¡ç‰‡æ˜¾ç¤º
          updateUsed('pad');
          updateUsed('tampon');
          updateUsed('clot');
          // æ›´æ–°æœˆç»æ¯æ•°æ®æ˜¾ç¤º
          if (parsed.useCup && data[currentDay - 1].cups && data[currentDay - 1].cups.length > 0) {
            const container = document.getElementById('cupEntries');
            if (container) {
              container.innerHTML = '';
              data[currentDay - 1].cups.forEach(cup => {
                const div = document.createElement('div');
                div.className = 'cup-entry';
                div.innerHTML = `
                  <div style="text-align: center">
                    <button onclick="adjustCupVolume(this, 5)" style="margin: 2px; padding: 2px 8px">+5mL</button>
                    <button onclick="adjustCupVolume(this, 1)" style="margin: 2px; padding: 2px 8px">+1mL</button>
                  </div>
                  <input type="number" value="${cup.volume}" min="0" placeholder="ml" style="margin: 5px 0">
                  <div style="text-align: center">
                    <button onclick="adjustCupVolume(this, -1)" style="margin: 2px; padding: 2px 8px">-1mL</button>
                    <button onclick="adjustCupVolume(this, -5)" style="margin: 2px; padding: 2px 8px">-5mL</button>
                  </div>
                `;
                container.appendChild(div);
              });
            }
          }
          // æ›´æ–°ä¸Šä¸€å¤©æŒ‰é’®çŠ¶æ€
          document.getElementById('prevDayBtn').disabled = currentDay === 1;
        } else {
          // å¦‚æœç”¨æˆ·é€‰æ‹©ä¸æ¢å¤ï¼Œåˆ™æ¸…é™¤æš‚å­˜æ•°æ®
          localStorage.removeItem('menstrualData');
        }
      }
    };

    // æš‚å­˜æ•°æ®åŠŸèƒ½
    function saveTemp() {
      const saveData = {
        data: data,
        currentDay: currentDay,
        totalDays: totalDays,
        usePad: document.getElementById('usePad').checked,
        useTampon: document.getElementById('useTampon').checked,
        useCup: document.getElementById('useCup').checked,
        timestamp: new Date().toLocaleString()
      };
      
      localStorage.setItem('menstrualData', JSON.stringify(saveData));
      
      // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
      const tempMsg = document.createElement('div');
      tempMsg.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(76, 175, 80, 0.9);
        color: white;
        padding: 15px 30px;
        border-radius: 5px;
        z-index: 1000;
      `;
      tempMsg.textContent = 'æ•°æ®æš‚å­˜æˆåŠŸï¼';
      document.body.appendChild(tempMsg);
      
      // 2ç§’åç§»é™¤æç¤º
      setTimeout(() => {
        tempMsg.remove();
      }, 2000);
    }

    // åˆå§‹åŒ–è®°å½•
    function startTracking() {
      totalDays = parseInt(document.getElementById('periodDays').value);
      data = Array.from({ length: totalDays }, () => ({ pads: [], tampons: [], cups: [], clots: [] }));
      document.getElementById('step1').classList.remove('active');
      document.getElementById('tracker').classList.add('active');
      document.querySelector('.message-box-container').style.display = 'none'; // éšè—è¯´æ˜æ–‡å­—å’Œå›¾ç‰‡
      currentDay = 1;
      showDay();
    }

    // æ¸²æŸ“å½“å¤©è®°å½•ç•Œé¢
    function showDay() {
      document.getElementById('currentDay').innerText = currentDay;
      // æ›´æ–°ä¸Šä¸€å¤©æŒ‰é’®çŠ¶æ€
      document.getElementById('prevDayBtn').disabled = currentDay === 1;
      const section = document.getElementById('productSection');
      section.innerHTML = '';

      if (document.getElementById('usePad').checked) {
        section.innerHTML += `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>å«ç”Ÿå·¾</h3>
            <button id="togglePaintMode" onclick="togglePaintMode()" class="paint-mode-btn">æ¶‚æŠ¹æ¨¡å¼(å°šæœªå®Œå–„)</button>
          </div>
          <div id="padCardsSection">
            <div class="card-table">` +
          padTypes.map(type => `
            <div class="card-column">
              <label class="card-label">${type} é•¿åº¦
                <select id="padLength_${type}" onchange="updatePadCards('${type}')">
                  ${Object.keys(padVolumes[type]).map(len => `<option value="${len}" ${len === 'ä¸­' ? 'selected' : ''}>${len}</option>`).join('')}
                </select>
              </label>
              <div class="card-grid" id="padCards_${type}"></div>
            </div>
          `).join('') + '</div><div class="used-cards" id="padUsed"></div></div>' +
          '<div id="paintModeSection" style="display: none;">' +
          '<div class="paint-controls">' +
          '<div class="pad-type-buttons">' +
          padTypes.map(type => 
            `<button onclick="addNewPad('${type}')" class="pad-add-btn">æ·»åŠ ${type}</button>`
          ).join('') +
          '</div>' +
          '<div class="paint-color-controls">' +
          '<label>æ¶‚æŠ¹é¢œè‰²ï¼š</label>' +
          '<input type="color" id="paintColor" value="#ff0000">' +
          '<label>ç¬”åˆ·å¤§å°ï¼š</label>' +
          '<input type="range" id="brushSize" min="1" max="20" value="5">' +
          '</div>' +
          '</div>' +
          '<div id="padsContainer" class="pads-container"></div>' +
          '</div>';
      }

      if (document.getElementById('useTampon').checked) {
        section.innerHTML += '<h3>æ£‰æ¡</h3><div class="card-table">' +
          tamponTypes.map(type => `
            <div class="card-column">
              <label class="card-label">${type} å¸æ”¶èƒ½åŠ›
                <select id="tamponAbsorbency_${type}" onchange="updateTamponCards('${type}')">
                  ${Object.keys(tamponVolumes[type]).map(level => `<option value="${level}" ${level === 'ä¸­' ? 'selected' : ''}>${level}</option>`).join('')}
                </select>
              </label>
              <div class="card-grid" id="tamponCards_${type}"></div>
            </div>
          `).join('') + '</div><div class="used-cards" id="tamponUsed"></div>';
      }

      if (document.getElementById('useCup').checked) {
        section.innerHTML += '<h3>æœˆç»æ¯</h3><button onclick="addCup()">+ æ·»åŠ æ¯å­</button>';
        section.innerHTML += '<div class="cup-entries" id="cupEntries"></div>';
      }

      section.innerHTML += '<div class="clot-container"><h3>è¡€å—</h3><div class="clot-card-table">' + 
        clotOptions.map(opt => `<div class="card" onclick="addClot('${opt.label}', ${opt.volume})">${opt.label} (${opt.volume}ml)<span class="delete-icon" title="æ·»åŠ ">â•</span></div>`).join('') +
        '</div><div class="clot-cards" id="clotUsed"></div></div>';

      padTypes.forEach(type => updatePadCards(type));
      tamponTypes.forEach(type => updateTamponCards(type));
      updateUsed('pad');
      updateUsed('tampon');
      updateUsed('clot');
    }

    function updatePadCards(type) {
      const container = document.getElementById(`padCards_${type}`);
      const selected = document.getElementById(`padLength_${type}`).value;
      container.innerHTML = saturationLevels.map(level => {
        const vol = padVolumes[type][selected][level];
        const isMobile = window.innerWidth <= 768;
        const content = isMobile ? 
          `<div class="card-info">
            <div>${type}</div>
            <div>${level}</div>
            <div>${vol}ml</div>
           </div>` :
          `${type} ${level} (${vol}ml)`;
        return `<div class="card" onclick="addPad('${type}', '${selected}', '${level}', ${vol})">${content}<span class="delete-icon" title="æ·»åŠ ">â•</span></div>`;
      }).join('');
    }

    function updateTamponCards(type) {
      const container = document.getElementById(`tamponCards_${type}`);
      const selected = document.getElementById(`tamponAbsorbency_${type}`).value;
      container.innerHTML = saturationLevels.map(level => {
        const vol = tamponVolumes[type][selected][level];
        const isMobile = window.innerWidth <= 768;
        const content = isMobile ? 
          `<div class="card-info">
            <div>${type}</div>
            <div>${level}</div>
            <div>${vol}ml</div>
           </div>` :
          `${type} ${level} (${vol}ml)`;
        return `<div class="card" onclick="addTampon('${type}', '${selected}', '${level}', ${vol})">${content}<span class="delete-icon" title="æ·»åŠ ">â•</span></div>`;
      }).join('');
    }

    function addPad(type, length, level, volume) {
      data[currentDay - 1].pads.push({ type, length, level, volume });
      updateUsed('pad');
    }
    function addTampon(type, absorbency, level, volume) {
      data[currentDay - 1].tampons.push({ type, absorbency, level, volume });
      updateUsed('tampon');
    }
    function addClot(label, volume) {
      data[currentDay - 1].clots.push({ label, volume });
      updateUsed('clot');
    }

    function updateUsed(productType) {
      const usedContainer = document.getElementById(`${productType}Used`);
      const list = data[currentDay - 1][`${productType}s`];
      usedContainer.innerHTML = list.map((item, i) => {
        let label = '';
        if (productType === 'pad') {
          label = `${item.type} ${item.length} ${item.level} (${item.volume}ml)`;
        } else if (productType === 'tampon') {
          label = `${item.type} ${item.absorbency} ${item.level} (${item.volume}ml)`;
        } else {
          label = `${item.label} (${item.volume}ml)`;
        }
        return `<div class="clot-card" onclick="removeItem('${productType}', ${i})">${label}<span class="delete-icon" title="åˆ é™¤">âŒ</span></div>`;
      }).join('');
    }

    function removeItem(type, index) {
      data[currentDay - 1][`${type}s`].splice(index, 1);
      updateUsed(type);
    }

    function addCup() {
      const container = document.getElementById('cupEntries');
      const div = document.createElement('div');
      div.className = 'cup-entry';
      
      // æ·»åŠ +5å’Œ+1æŒ‰é’®
      const topButtonGroup = document.createElement('div');
      topButtonGroup.style.textAlign = 'center';
      topButtonGroup.innerHTML = `
        <button onclick="adjustCupVolume(this, 5)" style="margin: 2px; padding: 2px 8px">+5mL</button>
        <button onclick="adjustCupVolume(this, 1)" style="margin: 2px; padding: 2px 8px">+1mL</button>
      `;
      div.appendChild(topButtonGroup);

      // è¾“å…¥æ¡†
      const input = document.createElement('input');
      input.type = 'number';
      input.value = '0';
      input.min = '0';
      input.placeholder = 'ml';
      input.style.margin = '5px 0';
      input.addEventListener('input', updateCup);
      div.appendChild(input);

      // æ·»åŠ -1å’Œ-5æŒ‰é’®
      const bottomButtonGroup = document.createElement('div');
      bottomButtonGroup.style.textAlign = 'center';
      bottomButtonGroup.innerHTML = `
        <button onclick="adjustCupVolume(this, -1)" style="margin: 2px; padding: 2px 8px">-1mL</button>
        <button onclick="adjustCupVolume(this, -5)" style="margin: 2px; padding: 2px 8px">-5mL</button>
      `;
      div.appendChild(bottomButtonGroup);

      container.appendChild(div);
      updateCup();
    }

    function adjustCupVolume(button, delta) {
      const cupEntry = button.closest('.cup-entry');
      const input = cupEntry.querySelector('input');
      const newValue = Math.max(0, parseFloat(input.value || 0) + delta);
      input.value = newValue;
      updateCup();
    }

    function updateCup() {
      const inputs = document.querySelectorAll('#cupEntries input');
      const volumes = Array.from(inputs).map(i => parseFloat(i.value) || 0);
      data[currentDay - 1].cups = volumes.map(v => ({ label: `æ¯ ${v}ml`, volume: v }));
    }

    function nextDay() {
      processVisiblePads(); // Process and clear pads before moving
      if (currentDay < totalDays) {
        currentDay++;
        showDay();
        document.getElementById('prevDayBtn').disabled = false;
      } else {
        showResult();
      }
    }

    function prevDay() {
      processVisiblePads(); // Process and clear pads before moving
      if (currentDay > 1) {
        currentDay--;
        showDay();
        document.getElementById('prevDayBtn').disabled = currentDay === 1;
      }
    }

    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}å¹´${month}æœˆ${day}æ—¥`;
    }

    async function saveAsImage() {
      try {
        const resultDiv = document.getElementById('result');
        // ä¸´æ—¶è°ƒæ•´æ ·å¼ä»¥ç¡®ä¿å®Œæ•´æ•è·
        const originalStyle = resultDiv.style.cssText;
        resultDiv.style.cssText = `
          padding: 40px;
          background: white;
          width: ${window.innerWidth <= 768 ? '100%' : '900px'};
          margin: 0 auto;
          position: relative;
          box-sizing: border-box;
        `;

        const canvas = await html2canvas(resultDiv, {
          scale: 2,
          useCORS: true,
          logging: false,
          windowWidth: window.innerWidth <= 768 ? window.innerWidth : 1000,
          width: window.innerWidth <= 768 ? window.innerWidth : 900,
          backgroundColor: '#ffffff'
        });
        
        // æ¢å¤åŸå§‹æ ·å¼
        resultDiv.style.cssText = originalStyle;

        // åˆ›å»ºä¸€ä¸ªæ–°çš„ a å…ƒç´ 
        const link = document.createElement('a');
        // è®¾ç½®ä¸‹è½½æ–‡ä»¶å
        const filename = `æœˆç»é‡æŠ¥å‘Š_${formatDate(new Date()).replace(/[å¹´æœˆæ—¥]/g, '')}.png`;
        
        // å°†canvasè½¬æ¢ä¸ºblob
        canvas.toBlob(function(blob) {
          // åˆ›å»ºblob URL
          const url = URL.createObjectURL(blob);
          
          // å°è¯•åœ¨æ–°çª—å£ä¸­æ‰“å¼€ Blob URLï¼Œæµè§ˆå™¨é€šå¸¸ä¼šè§¦å‘ä¸‹è½½
          const newWindow = window.open(url, '_blank');
          if (!newWindow) {
            alert('æ— æ³•æ‰“å¼€æ–°çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®å…è®¸å¼¹å‡ºçª—å£ã€‚');
          }

          // åœ¨çŸ­æ—¶é—´åé‡Šæ”¾ URLï¼Œç¡®ä¿ä¸‹è½½æœ‰æ—¶é—´å¼€å§‹
          setTimeout(() => {
            URL.revokeObjectURL(url);
          }, 1000); // å¢åŠ å»¶è¿Ÿç¡®ä¿ä¸‹è½½å¯åŠ¨
        }, 'image/png');
      } catch (error) {
        alert('ä¿å­˜å›¾ç‰‡æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•');
        console.error('Save image error:', error);
      }
    }

    async function saveAsPDF() {
      try {
        const resultDiv = document.getElementById('result');
        // ä¸´æ—¶è°ƒæ•´æ ·å¼ä»¥ç¡®ä¿å®Œæ•´æ•è·
        const originalStyle = resultDiv.style.cssText;
        resultDiv.style.cssText = `
          padding: ${window.innerWidth <= 768 ? '15px' : '40px'};
          background: white;
          width: ${window.innerWidth <= 768 ? '100%' : '900px'};
          margin: 0 auto;
          position: relative;
          box-sizing: border-box;
        `;

        const canvas = await html2canvas(resultDiv, {
          scale: 2,
          useCORS: true,
          logging: false,
          windowWidth: window.innerWidth <= 768 ? window.innerWidth : 1000,
          width: window.innerWidth <= 768 ? window.innerWidth : 900,
          backgroundColor: '#ffffff'
        });
        
        // æ¢å¤åŸå§‹æ ·å¼
        resultDiv.style.cssText = originalStyle;

        const { jsPDF } = window.jspdf;
        const imgData = canvas.toDataURL('image/png');
        
        // è®¡ç®—PDFå°ºå¯¸å’Œè¾¹è·
        const pageWidth = 210; // A4å®½åº¦(mm)
        const pageHeight = 297; // A4é«˜åº¦(mm)
        const margin = window.innerWidth <= 768 ? 10 : 20; // æ‰‹æœºç«¯ä½¿ç”¨æ›´å°çš„è¾¹è·
        
        // è®¡ç®—å¯ç”¨åŒºåŸŸ
        const usableWidth = pageWidth - (2 * margin);
        const usableHeight = pageHeight - (2 * margin);
        
        // è®¡ç®—å›¾ç‰‡ç¼©æ”¾åçš„å°ºå¯¸
        const imgRatio = canvas.height / canvas.width;
        let imgWidth = usableWidth;
        let imgHeight = imgWidth * imgRatio;
        
        // å¦‚æœé«˜åº¦è¶…å‡ºå¯ç”¨åŒºåŸŸï¼Œåˆ™æŒ‰é«˜åº¦ç¼©æ”¾
        if (imgHeight > usableHeight) {
          imgHeight = usableHeight;
          imgWidth = imgHeight / imgRatio;
        }
        
        // åˆ›å»ºPDF
        const pdf = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4'
        });
        
        // è®¡ç®—å±…ä¸­ä½ç½®
        const x = (pageWidth - imgWidth) / 2;
        const y = (pageHeight - imgHeight) / 2;
        
        // æ·»åŠ å›¾ç‰‡
        pdf.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight);

        // ç”Ÿæˆblob
        const pdfBlob = pdf.output('blob');
        
        // å°è¯•åœ¨æ–°çª—å£ä¸­æ‰“å¼€ Blob URLï¼Œæµè§ˆå™¨é€šå¸¸ä¼šè§¦å‘ä¸‹è½½
        const newWindow = window.open(URL.createObjectURL(pdfBlob), '_blank');
        if (!newWindow) {
          alert('æ— æ³•æ‰“å¼€æ–°çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®å…è®¸å¼¹å‡ºçª—å£ã€‚');
        }

        // åœ¨çŸ­æ—¶é—´åé‡Šæ”¾ URLï¼Œç¡®ä¿ä¸‹è½½æœ‰æ—¶é—´å¼€å§‹
        setTimeout(() => {
          URL.revokeObjectURL(URL.createObjectURL(pdfBlob));
        }, 1000); // å¢åŠ å»¶è¿Ÿç¡®ä¿ä¸‹è½½å¯åŠ¨
      } catch (error) {
        alert('ä¿å­˜PDFæ—¶å‡ºé”™ï¼Œè¯·é‡è¯•');
        console.error('Save PDF error:', error);
      }
    }

    // æ¶‚æŠ¹æ¨¡å¼ç›¸å…³å˜é‡å’Œå‡½æ•°
    let isPaintMode = false;
    let currentPadId = 0;

    function togglePaintMode() {
      isPaintMode = !isPaintMode;
      const btn = document.getElementById('togglePaintMode');
      const cardsSection = document.getElementById('padCardsSection');
      const paintSection = document.getElementById('paintModeSection');
      
      btn.classList.toggle('active');
      btn.textContent = isPaintMode ? 'è¿”å›å¡ç‰‡æ¨¡å¼' : 'åˆ‡æ¢æ¶‚æŠ¹æ¨¡å¼';
      cardsSection.style.display = isPaintMode ? 'none' : 'block';
      paintSection.style.display = isPaintMode ? 'block' : 'none';
    }

    // å«ç”Ÿå·¾æ¨¡æ¿å›¾ç‰‡è·¯å¾„
    const padTemplates = {
      'æ—¥ç”¨': {
        'çŸ­': 'templates/pad_daily_short.png',
        'ä¸­': 'templates/pad_daily_medium.png',
        'é•¿': 'templates/pad_daily_long.png'
      },
      'å¤œç”¨': {
        'çŸ­': 'templates/pad_night_short.png',
        'ä¸­': 'templates/pad_night_medium.png',
        'é•¿': 'templates/pad_night_long.png'
      },
      'å®‰å¿ƒè£¤': {
        'çŸ­': 'templates/pants_short.png',
        'ä¸­': 'templates/pants_medium.png',
        'é•¿': 'templates/pants_long.png'
      },
      'æŠ¤å«': {
        'çŸ­': 'templates/liner_short.png',
        'ä¸­': 'templates/liner_medium.png',
        'é•¿': 'templates/liner_long.png'
      }
    };

    // å­˜å‚¨æ¨¡æ¿çš„éé€æ˜åƒç´ ä¿¡æ¯
    const templatePixels = {};

    // åŠ è½½æ¨¡æ¿å›¾ç‰‡å¹¶è®¡ç®—éé€æ˜åƒç´ 
    async function loadTemplateImage(type, length) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          const tempCanvas = document.createElement('canvas');
          const canvasWidth = 200; // Target canvas width
          const canvasHeight = 300; // Target canvas height
          
          // Calculate scaling factor to fit image within canvas
          const scaleX = canvasWidth / img.width;
          const scaleY = canvasHeight / img.height;
          const scale = Math.min(scaleX, scaleY, 1); // Don't scale up
          
          const scaledWidth = img.width * scale;
          const scaledHeight = img.height * scale;
          const offsetX = (canvasWidth - scaledWidth) / 2;
          const offsetY = (canvasHeight - scaledHeight) / 2;
          
          tempCanvas.width = scaledWidth;
          tempCanvas.height = scaledHeight;
          const ctx = tempCanvas.getContext('2d');
          ctx.drawImage(img, 0, 0, scaledWidth, scaledHeight);
          
          const imageData = ctx.getImageData(0, 0, scaledWidth, scaledHeight);
          const pixels = imageData.data;
          const nonTransparentPixels = new Set();
          
          for (let i = 0; i < pixels.length; i += 4) {
            if (pixels[i + 3] > 0) { // alpha channel > 0
              const x = Math.round((i / 4) % scaledWidth);
              const y = Math.round(Math.floor((i / 4) / scaledWidth));
              nonTransparentPixels.add(`${x},${y}`);
            }
          }
          
          if (!templatePixels[type]) {
            templatePixels[type] = {};
          }
          templatePixels[type][length] = {
            image: img, // Keep original image for reference if needed
            nonTransparentPixels: nonTransparentPixels,
            totalNonTransparent: nonTransparentPixels.size,
            scaledWidth: scaledWidth,
            scaledHeight: scaledHeight,
            offsetX: offsetX,
            offsetY: offsetY,
            scale: scale
          };
          
          resolve(templatePixels[type][length]); // Resolve with the processed template data
        };
        img.onerror = reject;
        img.src = padTemplates[type][length];
      });
    }

    async function addNewPad(type) {
      try {
        // Check if template exists, load if not (only need default length initially)
        const initialLength = 'ä¸­';
        if (!templatePixels[type]?.[initialLength]) {
          await loadTemplateImage(type, initialLength);
        }
        
        const container = document.createElement('div');
        container.className = 'pad-canvas-container';
        container.id = `pad-container-${currentPadId}`;
        container.dataset.padId = currentPadId; // Add padId for easier access
        container.dataset.type = type; // Store type
        container.dataset.saved = 'false'; // Mark as not manually saved initially
        
        const canvas = document.createElement('canvas');
        canvas.className = 'pad-canvas';
        canvas.width = 200;
        canvas.height = 300;
        canvas.id = `pad-${currentPadId}`;
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = 'Ã—';
        deleteBtn.onclick = () => {
             // If manually saved, remove its data entry as well
            if (container.dataset.saved === 'true') {
                const padIndex = data[currentDay - 1].pads.findIndex(p => p.padId === container.dataset.padId);
                if (padIndex > -1) {
                    data[currentDay - 1].pads.splice(padIndex, 1);
                    updateUsed('pad');
                }
            }
            container.remove();
        };
        
        const saveBtn = document.createElement('button');
        saveBtn.className = 'save-btn';
        saveBtn.textContent = 'ä¿å­˜';
        // Link save button directly to the specific container/padId
        saveBtn.onclick = () => savePadData(container.dataset.padId);
        
        const infoDiv = document.createElement('div');
        infoDiv.className = 'pad-info';
        
        const typeSpan = document.createElement('span');
        typeSpan.textContent = type;
        
        const lengthSelect = document.createElement('select');
        lengthSelect.id = `pad-length-${currentPadId}`;
        ['çŸ­', 'ä¸­', 'é•¿'].forEach(length => {
          const option = document.createElement('option');
          option.value = length;
          option.textContent = `${length}`;
          if (length === initialLength) option.selected = true;
          lengthSelect.appendChild(option);
        });
        
        lengthSelect.onchange = async () => {
          const selectedLength = lengthSelect.value;
          // Only load if not already loaded
          if (!templatePixels[type]?.[selectedLength]) {
            await loadTemplateImage(type, selectedLength);
          }
          // Redraw with new template, potentially clearing previous drawing
          drawTemplate(canvas, type, selectedLength);
          // Reset saved status if length changes after save
          container.dataset.saved = 'false'; 
          const volumeDisplay = container.querySelector('.saved-volume');
          if (volumeDisplay) volumeDisplay.remove();
        };

        // Placeholder for displaying saved volume
        const volumeDisplaySpan = document.createElement('span');
        volumeDisplaySpan.className = 'saved-volume';
        volumeDisplaySpan.style.marginLeft = 'auto'; // Push to the right
        
        infoDiv.appendChild(typeSpan);
        infoDiv.appendChild(lengthSelect);
        infoDiv.appendChild(volumeDisplaySpan); // Add span to info div
        
        container.appendChild(canvas);
        container.appendChild(deleteBtn);
        container.appendChild(saveBtn);
        container.appendChild(infoDiv);
        
        document.getElementById('padsContainer').appendChild(container);
        
        drawTemplate(canvas, type, initialLength);
        setupPadCanvas(canvas);
        currentPadId++;
      } catch (error) {
        console.error('Error adding new pad:', error);
        alert('åŠ è½½å«ç”Ÿå·¾æ¨¡æ¿å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ¨¡æ¿å›¾ç‰‡æ˜¯å¦å­˜åœ¨ã€‚');
      }
    }

    function drawTemplate(canvas, type, length) {
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#ffffff'; 
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      const template = templatePixels[type]?.[length];
      if (template) {
        // Draw the scaled template centered
        ctx.drawImage(template.image, 
                      template.offsetX, template.offsetY, 
                      template.scaledWidth, template.scaledHeight);
      }
    }

    // Removed 'type' parameter as it's now stored in container dataset
    function setupPadCanvas(canvas) { 
      let isDrawing = false;
      let lastX = 0;
      let lastY = 0;
      const container = canvas.closest('.pad-canvas-container'); // Get parent container
      
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);
      
      canvas.addEventListener('touchstart', handleTouch);
      canvas.addEventListener('touchmove', handleTouch);
      canvas.addEventListener('touchend', stopDrawing);
      
      function startDrawing(e) {
        // Reset saved status if user starts drawing again after saving
        if (container.dataset.saved === 'true') {
            container.dataset.saved = 'false';
            const volumeDisplay = container.querySelector('.saved-volume');
             if (volumeDisplay) volumeDisplay.textContent = ''; // Clear displayed volume
             // Remove potentially existing data entry
             const padIndex = data[currentDay - 1].pads.findIndex(p => p.padId === container.dataset.padId);
             if (padIndex > -1) {
                 data[currentDay - 1].pads.splice(padIndex, 1);
                 updateUsed('pad');
             }
        }
        isDrawing = true;
        [lastX, lastY] = getCoordinates(e);
      }
      
      function draw(e) {
        if (!isDrawing) return;
        
        const ctx = canvas.getContext('2d');
        const [currentX, currentY] = getCoordinates(e);
        
        const padId = container.dataset.padId;
        const type = container.dataset.type;
        const lengthSelect = document.getElementById(`pad-length-${padId}`);
        const selectedLength = lengthSelect.value;
        const template = templatePixels[type]?.[selectedLength];
        
        if (template) {
          // Map canvas coordinates to scaled template coordinates
          const templateX = Math.round(currentX - template.offsetX);
          const templateY = Math.round(currentY - template.offsetY);
          
          // Check if the point is within the non-transparent area of the scaled template
          if (template.nonTransparentPixels.has(`${templateX},${templateY}`)) {
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(currentX, currentY);
            ctx.strokeStyle = document.getElementById('paintColor').value;
            ctx.lineWidth = document.getElementById('brushSize').value;
            ctx.lineCap = 'round';
            // Use 'source-over' to draw normally, template is redrawn if length changes
            ctx.globalCompositeOperation = 'source-over'; 
            ctx.stroke();
          }
        }
        
        [lastX, lastY] = [currentX, currentY];
      }
      
      function stopDrawing() {
        isDrawing = false;
      }
      
      function getCoordinates(e) {
        const rect = canvas.getBoundingClientRect();
        if (e.type.includes('touch')) {
          return [
            e.touches[0].clientX - rect.left,
            e.touches[0].clientY - rect.top
          ];
        }
        return [
          e.clientX - rect.left,
          e.clientY - rect.top
        ];
      }
      
      function handleTouch(e) {
        e.preventDefault();
        const touch = e.type === 'touchstart' ? startDrawing : draw;
        touch(e);
      }
    }

    // Renamed function for clarity and added parameter
    function calculatePadVolume(padId) {
      const container = document.getElementById(`pad-container-${padId}`);
      if (!container) return null;

      const canvas = document.getElementById(`pad-${padId}`);
      const type = container.dataset.type;
      const lengthSelect = document.getElementById(`pad-length-${padId}`);
      const selectedLength = lengthSelect.value;
      const ctx = canvas.getContext('2d');
      const template = templatePixels[type]?.[selectedLength];

      if (!template || template.totalNonTransparent === 0) {
        console.error('Template or non-transparent pixels not found or zero for', type, selectedLength);
        return { volume: 0, level: 'æœªçŸ¥', coverage: 0 }; // Return zero volume if template is invalid
      }

      const imageData = ctx.getImageData(template.offsetX, template.offsetY, 
                                         template.scaledWidth, template.scaledHeight);
      const pixels = imageData.data;
      
      let redPixels = 0;
      // Iterate only over the template's non-transparent pixels for efficiency
      template.nonTransparentPixels.forEach(coord => {
          const [px, py] = coord.split(',').map(Number);
          const index = (py * Math.round(template.scaledWidth) + px) * 4;
          if (pixels[index] > 200 && pixels[index + 1] < 100 && pixels[index + 2] < 100) { // Check if red
              redPixels++;
          }
      });

      const coverage = redPixels / template.totalNonTransparent;
      const maxCapacity = padVolumes[type][selectedLength].maxCapacity;
      const volume = coverage * maxCapacity;
      
      let level;
      if (coverage < 0.01) { // Handle near zero coverage
        level = 'æœªæŸ“è‰²';
      } else if (coverage < 0.2) {
        level = 'æŸ“äº†ä¸€ç‚¹';
      } else if (coverage < 0.5) {
        level = 'æŸ“äº†ä¸€åŠ';
      } else {
        level = 'å…¨æŸ“çº¢';
      }
      
      return { volume, level, coverage };
    }

    // Manual save function
    function savePadData(padId) {
        const container = document.getElementById(`pad-container-${padId}`);
        if (!container || container.dataset.saved === 'true') return; // Don't re-save

        const calculation = calculatePadVolume(padId);
        if (!calculation) return; // Calculation failed
        
        const { volume, level } = calculation;
        const type = container.dataset.type;
        const selectedLength = document.getElementById(`pad-length-${padId}`).value;

        // Display volume
        const volumeDisplay = container.querySelector('.saved-volume');
        if (volumeDisplay) {
            volumeDisplay.textContent = `è¡€é‡: ${volume.toFixed(2)}ml`;
        }

        // Remove previous entry if exists (e.g., saved, then edited)
        const existingIndex = data[currentDay - 1].pads.findIndex(p => p.padId === padId);
        if (existingIndex > -1) {
            data[currentDay - 1].pads.splice(existingIndex, 1);
        }

        // Add data
        data[currentDay - 1].pads.push({
            type: type,
            length: selectedLength,
            level: level, // Use calculated level
            volume: volume,
            isPainted: true, // Mark as painted
            padId: padId // Store ID to link data entry to canvas if needed
        });

        container.dataset.saved = 'true'; // Mark as manually saved
        updateUsed('pad'); // Update the list of used pads
    }

    // Automatic processing function
    function processVisiblePads() {
        const padsContainer = document.getElementById('padsContainer');
        if (!padsContainer) return;

        const padElements = padsContainer.querySelectorAll('.pad-canvas-container');
        padElements.forEach(container => {
            // Only process pads that haven't been manually saved
            if (container.dataset.saved === 'false') {
                const padId = container.dataset.padId;
                const calculation = calculatePadVolume(padId);
                
                if (calculation && calculation.volume > 0) { // Only save if there is some volume
                    const { volume, level } = calculation;
                    const type = container.dataset.type;
                    const selectedLength = document.getElementById(`pad-length-${padId}`).value;
                    
                    data[currentDay - 1].pads.push({
                        type: type,
                        length: selectedLength,
                        level: level,
                        volume: volume,
                        isPainted: true,
                        padId: padId
                    });
                }
            }
            // Remove the canvas container after processing (or if manually saved)
            container.remove(); 
        });
        // Update the list after processing all
        if (padElements.length > 0) {
             updateUsed('pad');
        }
        // Clear the container explicitly
        padsContainer.innerHTML = ''; 
    }

    function showResult() {
      processVisiblePads();
      document.getElementById('tracker').classList.remove('active');
      document.getElementById('result').classList.add('active');
      
      // æ˜¾ç¤ºå½“å‰æ—¥æœŸ
      const dateDisplay = document.querySelector('.date-display');
      dateDisplay.textContent = formatDate(new Date());
      
      let total = 0;
      const table = document.getElementById('resultTable');
      table.innerHTML = '';
      
      // å‡†å¤‡å›¾è¡¨æ•°æ®
      const dailyVolumes = [];
      const dayLabels = [];
      
      data.forEach((day, i) => {
        const dayItems = [...day.pads, ...day.tampons, ...day.cups, ...day.clots];
        const dayTotal = dayItems.reduce((sum, item) => sum + item.volume, 0);
        total += dayTotal;
        dailyVolumes.push(dayTotal);
        dayLabels.push(`ç¬¬${i + 1}å¤©`);
        
        const details = dayItems.map(item => {
          if (item.type && item.length) return `${item.type} ${item.length} ${item.level} (${item.volume.toFixed(2)}ml)`;
          if (item.type && item.absorbency) return `${item.type} ${item.absorbency} ${item.level} (${item.volume.toFixed(2)}ml)`;
          return `${item.label} (${item.volume.toFixed(2)}ml)`;
        }).join(', ');
        table.innerHTML += `<tr><td>ç¬¬ ${i + 1} å¤©</td><td>${dayItems.length} é¡¹</td><td>${dayTotal.toFixed(2)} ml</td><td>${details}</td></tr>`;
      });
      
      document.getElementById('totalVolume').innerText = total.toFixed(2);
      
      // è®¡ç®—æ¦‚ç‡å’Œå»ºè®®
      let probability = 0;
      let suggestion = '';
      
      if (total <= 25) {
        probability = 5;
        suggestion = "æ‚¨å¯èƒ½æœˆç»è¾ƒå°‘";
      } else if (total <= 50) {
        probability = 15;
        suggestion = "æ‚¨çš„æœˆç»é‡å¤„äºæ­£å¸¸èŒƒå›´";
      } else if (total <= 75) {
        probability = 35;
        suggestion = "æ‚¨çš„æœˆç»é‡å¤„äºæ­£å¸¸èŒƒå›´";
      } else if (total <= 90) {
        probability = 65;
        suggestion = "æ‚¨çš„æœˆç»é‡ç¨å¤šï¼Œä½†å¤„äºæ­£å¸¸èŒƒå›´";
      } else if (total <= 100) {
        probability = 85;
        suggestion = "æ‚¨çš„æœˆç»é‡ç¨å¤š";
      } else if (total <= 110) {
        probability = 90;
        suggestion = "æ‚¨å¯èƒ½æœ‰æœˆç»è¿‡å¤š";
      } else if (total <= 125) {
        probability = 95;
        suggestion = "æ‚¨éå¸¸å¯èƒ½æœ‰æœˆç»è¿‡å¤š";
      } else if (total <= 150) {
        probability = 98;
        suggestion = "å»ºè®®æ‚¨åŠæ—¶å°±åŒ»";
      } else {
        probability = 99;
        suggestion = "å»ºè®®æ‚¨åŠæ—¶å°±åŒ»";
      }
      
      document.getElementById('probability').innerText = probability;
      document.getElementById('suggestion').innerText = suggestion;
      
      // åˆ›å»ºæŸ±çŠ¶å›¾
      new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: {
          labels: dayLabels,
          datasets: [{
            label: 'æ¯æ—¥å‡ºè¡€é‡å æ¯”',
            data: dailyVolumes,
            backgroundColor: 'rgba(255, 99, 132, 0.7)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: window.innerWidth <= 768 ? 1.2 : 2,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.raw;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `å æ¯”: ${percentage}% (${value.toFixed(2)}ml)`;
                }
              }
            },
            title: {
              display: true,
              text: 'æ¯æ—¥å‡ºè¡€é‡åˆ†å¸ƒ',
              font: {
                size: window.innerWidth <= 768 ? 14 : 16
              }
            },
            legend: {
              labels: {
                font: {
                  size: window.innerWidth <= 768 ? 12 : 14
                }
              }
            },
            datalabels: {
              anchor: 'end',
              align: 'top',
              formatter: (value, ctx) => {
                const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return `${value.toFixed(2)}ml\n(${percentage}%)`;
              },
              font: {
                size: window.innerWidth <= 768 ? 11 : 12,
                weight: 'bold'
              },
              color: '#666'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'å‡ºè¡€é‡ (ml)',
                font: {
                  size: window.innerWidth <= 768 ? 12 : 14
                }
              },
              ticks: {
                font: {
                  size: window.innerWidth <= 768 ? 11 : 12
                }
              },
              suggestedMax: Math.max(...dailyVolumes) * 1.1
            },
            x: {
              ticks: {
                font: {
                  size: window.innerWidth <= 768 ? 11 : 12
                }
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
      
      // åˆ›å»ºé¥¼å›¾
      new Chart(document.getElementById('pieChart'), {
        type: 'pie',
        data: {
          labels: dayLabels,
          datasets: [{
            data: dailyVolumes,
            backgroundColor: [
              'rgba(255, 99, 132, 0.7)',
              'rgba(54, 162, 235, 0.7)',
              'rgba(255, 206, 86, 0.7)',
              'rgba(75, 192, 192, 0.7)',
              'rgba(153, 102, 255, 0.7)',
              'rgba(255, 159, 64, 0.7)',
              'rgba(199, 199, 199, 0.7)',
              'rgba(83, 102, 255, 0.7)',
              'rgba(40, 159, 64, 0.7)',
              'rgba(210, 199, 199, 0.7)'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: window.innerWidth <= 768 ? 1 : 1,
          plugins: {
            title: {
              display: true,
              text: 'å‡ºè¡€é‡å æ¯”åˆ†å¸ƒ',
              font: {
                size: window.innerWidth <= 768 ? 14 : 16
              }
            },
            legend: {
              position: window.innerWidth <= 768 ? 'bottom' : 'right',
              align: 'center',
              labels: {
                boxWidth: window.innerWidth <= 768 ? 15 : 40,
                padding: window.innerWidth <= 768 ? 8 : 10,
                font: {
                  size: window.innerWidth <= 768 ? 11 : 12
                }
              }
            },
            datalabels: {
              formatter: (value, ctx) => {
                const sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((value / sum) * 100).toFixed(1);
                // å½“æ¯”ä¾‹ä¸º0æ—¶è¿”å›ç©ºå­—ç¬¦ä¸²ï¼Œè¿™æ ·å°±ä¸ä¼šæ˜¾ç¤ºæ ‡ç­¾
                return percentage === '0.0' ? '' : `${percentage}%\n(${value.toFixed(2)}ml)`;
              },
              color: '#fff',
              font: {
                size: window.innerWidth <= 768 ? 11 : 13,
                weight: 'bold'
              },
              textAlign: 'center',
              textStroke: {
                color: 'rgba(0, 0, 0, 0.5)',
                width: 2
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    // æ·»åŠ äºŒç»´ç ç”ŸæˆåŠŸèƒ½
    document.addEventListener('DOMContentLoaded', function() {
      const qrTriggers = document.querySelectorAll('.qr-code-trigger');
      const modal = document.getElementById('qrCodeModal');
      const closeBtn = document.querySelector('.close-modal');

      qrTriggers.forEach(trigger => {
        trigger.addEventListener('click', function() {
          const text = this.getAttribute('data-qr');
          const qrcode = new QRCode(document.getElementById("qrcode"), {
            text: text,
            width: 200,
            height: 200
          });
          modal.style.display = "block";
        });
      });

      closeBtn.addEventListener('click', function() {
        modal.style.display = "none";
        document.getElementById("qrcode").innerHTML = "";
      });

      window.addEventListener('click', function(event) {
        if (event.target == modal) {
          modal.style.display = "none";
          document.getElementById("qrcode").innerHTML = "";
        }
      });
    });

    function downloadFile() {
      // åœ¨è¿™é‡Œæ·»åŠ æ–‡ä»¶ä¸‹è½½é€»è¾‘
      const link = document.createElement('a');
      link.href = 'pbac/pbac.xlsx'; // æ›¿æ¢ä¸ºå®é™…æ–‡ä»¶è·¯å¾„
      link.download = 'pbac.xlsx'; // æ›¿æ¢ä¸ºå®é™…æ–‡ä»¶å
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</body>
</html>